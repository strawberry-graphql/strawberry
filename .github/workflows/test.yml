name: ðŸ”‚ Unit tests

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - "strawberry/**"
      - "tests/**"
      - "noxfile.py"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/test.yml"

permissions:
  contents: read

jobs:
  generate-jobs-tests:
    name: ðŸ’» Generate test matrix
    runs-on: ubuntu-latest
    outputs:
      sessions: ${{ steps.set-matrix.outputs.sessions }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
      - run: uv sync
      - id: set-matrix
        shell: bash
        run: |
          echo sessions=$(
            uv run nox --json -t tests -l |
            jq 'map(
              {
                session,
                name: "\( .name ) on \( .python )\( if .call_spec != {} then " (\(.call_spec | to_entries | map("\(.key)=\(.value)") | join(", ")))" else "" end )"
              }
            )'
          ) | tee --append $GITHUB_OUTPUT

  unit-tests:
    name: ðŸ”¬ ${{ matrix.session.name }}
    needs: [generate-jobs-tests]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        session: ${{ fromJson(needs.generate-jobs-tests.outputs.sessions) }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true

      - run: uv sync
      - run: uv run nox -r -t tests -s "${{ matrix.session.session }}"
      - name: Rename coverage data
        if: ${{ always() }}
        run: |
          if [ -f .coverage ]; then
            mv .coverage ".coverage.${{ matrix.session.session }}"
          fi
      - name: Upload coverage data
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ always() }}
        with:
          name: coverage-data-${{ matrix.session.session }}
          path: ".coverage.${{ matrix.session.session }}"
          include-hidden-files: true
          if-no-files-found: ignore

  coverage:
    name: ðŸ“Š Combine & check coverage
    if: always()
    needs: [unit-tests, unit-tests-on-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: coverage-data-*
          merge-multiple: true

      - name: Combine coverage & generate report
        run: |
          uv run --with coverage[toml] --with diff-cover coverage combine
          uv run --with coverage[toml] coverage xml
          uv run --with coverage[toml] coverage html --skip-covered --skip-empty
          uv run --with coverage[toml] coverage report --format=markdown >> $GITHUB_STEP_SUMMARY

      - name: Generate diff coverage report
        if: github.event_name == 'pull_request'
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          echo "## Diff Coverage" >> $GITHUB_STEP_SUMMARY
          uv run --with coverage[toml] --with diff-cover diff-cover coverage.xml --compare-branch="origin/$BASE_REF" --markdown-report diff-cover.md --fail-under=0 || true
          cat diff-cover.md >> $GITHUB_STEP_SUMMARY

      - name: Upload HTML report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: html-report
          path: coverage_html_report

  benchmarks:
    name: ðŸ“ˆ Benchmarks

    # Using this version because CodSpeed doesn't support Ubuntu 24.04 LTS yet
    runs-on: ubuntu-22.04

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true
          python-version: "3.12"

      - run: uv sync

      - name: Run benchmarks
        uses: CodSpeedHQ/action@0d7de549485db8284c0b87a0d2c0dd871097e641 # v4
        with:
          mode: simulation
          run: uv run pytest tests/benchmarks --codspeed -p no:codeflash-benchmark

  lint:
    name: âœ¨ Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true
          python-version: "3.12"

      - run: uv sync

      - run: |
          mkdir -p .mypy_cache

          uv run mypy --install-types --non-interactive --cache-dir=.mypy_cache/ --config-file mypy.ini

  unit-tests-on-windows:
    name: ðŸªŸ Tests on Windows
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true
          python-version: "3.11"

      - run: uv sync

      # we use uv directly instead of nox since we want to
      # test all integrations at once on windows
      - run: |
          uv run pytest --cov=. --cov-append -n auto --showlocals -vv

      - name: Rename coverage data
        if: ${{ always() }}
        shell: bash
        run: |
          if [ -f .coverage ]; then
            mv .coverage .coverage.windows
          fi

      - name: Upload coverage data
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ always() }}
        with:
          name: coverage-data-windows
          path: .coverage.windows
          include-hidden-files: true
          if-no-files-found: ignore
